# -*- coding: utf-8 -*-
##
#    Copyright (c) 2015 Cyrus Daboo. All rights reserved.
#
#    Licensed under the Apache License, Version 2.0 (the "License");
#    you may not use this file except in compliance with the License.
#    You may obtain a copy of the License at
#
#        http://www.apache.org/licenses/LICENSE-2.0
#
#    Unless required by applicable law or agreed to in writing, software
#    distributed under the License is distributed on an "AS IS" BASIS,
#    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#    See the License for the specific language governing permissions and
#    limitations under the License.
##

from difflib import unified_diff
from pycalendar.datetime import DateTime
from pycalendar.icalendar import definitions
from pycalendar.icalendar.calendar import Calendar
from pycalendar.icalendar.patch import Patch
from pycalendar.icalendar.patchprocessing import Command, Path, PatchDocument, PatchGenerator
from pycalendar.icalendar.property import Property
from pycalendar.icalendar.vpatch import VPatch
import itertools
import json
import operator
import os
import unittest


dataValid = {
    "create_component_simple": [
        {
            "title": "Add one component to a calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Add two components to a calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:165EF135-BA92-435A-88C9-562F95030908
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:April Fool's Day
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:165EF135-BA92-435A-88C9-562F95030908
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:April Fool's Day
END:VEVENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Add one component to an event",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:Event reminder
TRIGGER:-PT8M
UID:D9D1AC84-F629-4B9D-9B6B-4A6CA9A11FEF
END:VALARM
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
BEGIN:VALARM
UID:D9D1AC84-F629-4B9D-9B6B-4A6CA9A11FEF
DESCRIPTION:Event reminder
TRIGGER:-PT8M
ACTION:DISPLAY
END:VALARM
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
    ],

    "create_property_simple": [
        {
            "title": "Add one property to a calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
CALSCALE:GREGORIAN
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Add two properties to a calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
REFRESH-INTERVAL:10
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
CALSCALE:GREGORIAN
REFRESH-INTERVAL:10
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Add one property to an event",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
STATUS:CANCELLED
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
STATUS:CANCELLED
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Add two properties to an event",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
STATUS:CANCELLED
SUMMARY:New Year's Day
TRANSP:TRANSPARENT
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
STATUS:CANCELLED
TRANSP:TRANSPARENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Add one multi-property to an event",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
CATEGORIES:Holiday
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
CATEGORIES:Holiday
CATEGORIES:Party
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
CATEGORIES;PATCH-ACTION=CREATE:Party
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Add one component and one property to an event",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
STATUS:CONFIRMED
SUMMARY:New Year's Day
BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:Get ready for party!
TRIGGER:-P1D
END:VALARM
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
STATUS:CONFIRMED
BEGIN:VALARM
TRIGGER:-P1D
ACTION:DISPLAY
DESCRIPTION:Get ready for party!
END:VALARM
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
    ],

    "create_parameter_simple": [
        {
            "title": "Add one parameter to a property",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY;LANGUAGE=en_US:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-PARAMETER;LANGUAGE=en_US:#SUMMARY
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Add two parameters to a calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY;ALTREP="cid:xyz@example.com";LANGUAGE=en_US:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-PARAMETER;LANGUAGE=en_US;ALTREP="cid:xyz@example.com":#SUMMARY
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
    ],

    "update_component_simple": [
        {
            "title": "Update one component in a calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day - party time
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day - party time
END:VEVENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Update one, add another component to a calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day - party time
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID;VALUE=DATE:20030101
DTSTART;VALUE=DATE:20030101
DTEND;VALUE=DATE:20030102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
STATUS:CANCELLED
SUMMARY:New Year's Day - cancelled
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day - party time
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID;VALUE=DATE:20030101
DTSTART;VALUE=DATE:20030101
DTEND;VALUE=DATE:20030102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
STATUS:CANCELLED
SUMMARY:New Year's Day - cancelled
END:VEVENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Update one component in a calendar with others present",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day - party time
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID;VALUE=DATE:20030101
DTSTART;VALUE=DATE:20030101
DTEND;VALUE=DATE:20030102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
STATUS:CANCELLED
SUMMARY:New Year's Day - cancelled
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day - party time
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID;VALUE=DATE:20030101
DTSTART;VALUE=DATE:20030101
DTEND;VALUE=DATE:20030102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day - it is on again!
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID;VALUE=DATE:20030101
DTSTART;VALUE=DATE:20030101
DTEND;VALUE=DATE:20030102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day - it is on again!
END:VEVENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
    ],

    "update_component_recur": [
        {
            "title": "Update one property in an instance",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID;VALUE=DATE:20030101
DTSTART;VALUE=DATE:20030101
DTEND;VALUE=DATE:20030102
DTSTAMP:20020101T000000Z
SUMMARY:New Year's Day - party time
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT[UID=C3184A66-1ED0-11D9-A5E0-000A958A3252][RID=20030101]
SUMMARY:New Year's Day - party time
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
    ],

    "update_property_simple": [
        {
            "title": "Update (add) one property in a calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day
TRANSP:TRANSPARENT
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
TRANSP:TRANSPARENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Update (existing) property in a calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day
TRANSP:OPAQUE
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day
TRANSP:TRANSPARENT
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
TRANSP:TRANSPARENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Update one property in all events",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:165EF135-BA92-435A-88C9-562F95030908
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:April Fool's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:165EF135-BA92-435A-88C9-562F95030908
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
STATUS:CONFIRMED
SUMMARY:April Fool's Day
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
STATUS:CONFIRMED
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
STATUS:CONFIRMED
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Update one property in one event",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
STATUS:CANCELLED
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:165EF135-BA92-435A-88C9-562F95030908
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
STATUS:CANCELLED
SUMMARY:April Fool's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:165EF135-BA92-435A-88C9-562F95030908
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
STATUS:CANCELLED
SUMMARY:April Fool's Day
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
STATUS:CONFIRMED
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT[UID=C3184A66-1ED0-11D9-A5E0-000A958A3252]
STATUS:CONFIRMED
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Update (existing) properties in a calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day
TRANSP:OPAQUE
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day non blocking
TRANSP:TRANSPARENT
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
SUMMARY:New Year's Day non blocking
TRANSP:TRANSPARENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
    ],

    "update_parameter_simple": [
        {
            "title": "Update one parameter in a property",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY;LANGUAGE=en_US:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY;LANGUAGE=en_GB:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-PARAMETER;LANGUAGE=en_GB:#SUMMARY
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Update two parameters in a property",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY;ALTREP="cid:abc@example.com";LANGUAGE=en_US:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY;ALTREP="cid:xyz@example.com";LANGUAGE=en_GB:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-PARAMETER;LANGUAGE=en_GB;ALTREP="cid:xyz@example.com":#SUMMARY
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
    ],

    "delete_component_simple": [
        {
            "title": "Delete one component from single event calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
PATCH-DELETE:/VEVENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Delete one component from multi event calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:165EF135-BA92-435A-88C9-562F95030908
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:April Fool's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:165EF135-BA92-435A-88C9-562F95030908
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:April Fool's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
PATCH-DELETE:/VEVENT[UID=C3184A66-1ED0-11D9-A5E0-000A958A3252]
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Delete all components from multi event calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:165EF135-BA92-435A-88C9-562F95030908
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:April Fool's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
PATCH-DELETE:/VEVENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Delete one alarm from single event calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
BEGIN:VALARM
UID:D9D1AC84-F629-4B9D-9B6B-4A6CA9A11FEF
DESCRIPTION:Event reminder
TRIGGER:-PT8M
ACTION:DISPLAY
END:VALARM
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-DELETE:/VALARM
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Delete one alarm from single multi alarm event calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
BEGIN:VALARM
UID:D9D1AC84-F629-4B9D-9B6B-4A6CA9A11FEF
DESCRIPTION:Event reminder
TRIGGER:-PT8M
ACTION:DISPLAY
END:VALARM
BEGIN:VALARM
UID:D78F6991-DFDD-491B-8334-FA9BF8E4F11C
DESCRIPTION:Event reminder
TRIGGER:-PT8M
ACTION:DISPLAY
END:VALARM
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
BEGIN:VALARM
ACTION:DISPLAY
DESCRIPTION:Event reminder
TRIGGER:-PT8M
UID:D9D1AC84-F629-4B9D-9B6B-4A6CA9A11FEF
END:VALARM
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-DELETE:/VALARM[UID=D78F6991-DFDD-491B-8334-FA9BF8E4F11C]
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
    ],

    "delete_property_simple": [
        {
            "title": "Delete one property from VCALENDAR",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
PATCH-DELETE:#CALSCALE
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Delete one property from VEVENT",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-DELETE:#RRULE
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Delete one property from multi event calendar",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:DFAEA248-AC4E-44D6-8FA3-ACAAA7BA7943
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:April Fool's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:DFAEA248-AC4E-44D6-8FA3-ACAAA7BA7943
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:April Fool's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT[UID=C3184A66-1ED0-11D9-A5E0-000A958A3252]
PATCH-DELETE:#RRULE
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Delete one of many properties from VEVENT",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user03@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-DELETE:#ATTENDEE[=mailto:user03@example.com]
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Delete one of many properties from one of many VEVENTs",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user03@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID;VALUE=DATE:20120101
DTSTART;VALUE=DATE:20120101
DTEND;VALUE=DATE:20120102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user03@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user03@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID;VALUE=DATE:20120101
DTSTART;VALUE=DATE:20120101
DTEND;VALUE=DATE:20120102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT[RID=20120101]
PATCH-DELETE:#ATTENDEE[=mailto:user03@example.com]
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Delete two properties from VCALENDAR",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
DESCRIPTION:Test
LOCATION:Times Square
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-DELETE:#DESCRIPTION
PATCH-DELETE:#LOCATION
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
    ],

    "delete_parameter_simple": [
        {
            "title": "Delete parameter from all properties in VEVENT",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user03@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
ATTENDEE:mailto:user01@example.com
ATTENDEE:mailto:user02@example.com
ATTENDEE:mailto:user03@example.com
ATTENDEE:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-DELETE:#ATTENDEE;PARTSTAT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Delete parameter from one property in VEVENT",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user03@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE:mailto:user03@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-DELETE:#ATTENDEE[=mailto:user03@example.com];PARTSTAT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
        {
            "title": "Delete one parameter from one of many parameters from one of many VEVENTs",
            "before": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user03@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID;VALUE=DATE:20120101
DTSTART;VALUE=DATE:20120101
DTEND;VALUE=DATE:20120102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user03@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "after": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user03@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID;VALUE=DATE:20120101
DTSTART;VALUE=DATE:20120101
DTEND;VALUE=DATE:20120102
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user01@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user02@example.com
ATTENDEE:mailto:user03@example.com
ATTENDEE;PARTSTAT=NEEDS-ACTION:mailto:user04@example.com
DTSTAMP:20020101T000000Z
ORGANIZER:mailto:user01@example.com
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
""",
            "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT[RID=20120101]
PATCH-DELETE:#ATTENDEE[=mailto:user03@example.com];PARTSTAT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
        },
    ],
}

dataInvalid = [
    {
        "title": "PATCH component - multiple targets",
        "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-TARGET:/VCALENDAR/VTODO
SUMMARY:Changed
SUMMARY:foo
END:PATCH
END:VPATCH
END:VCALENDAR
""",
    },
    {
        "title": "PATCH component - no target",
        "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
SUMMARY:Changed
SUMMARY:foo
END:PATCH
END:VPATCH
END:VCALENDAR
""",
    },
    {
        "title": "PATCH component or property - at least one component or property",
        "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
END:PATCH
END:VPATCH
END:VCALENDAR
""",
    },
    {
        "title": "PATCH component - property no name path not allowed",
        "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT#
SUMMARY:foo
END:PATCH
END:VPATCH
END:VCALENDAR
""",
    },
    {
        "title": "PATCH component - property with name path not allowed",
        "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT#SUMMARY
SUMMARY:foo
END:PATCH
END:VPATCH
END:VCALENDAR
""",
    },
    {
        "title": "PATCH component - parameter with no name path not allowed",
        "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT#DESCRIPTIOPN;
SUMMARY:foo
END:PATCH
END:VPATCH
END:VCALENDAR
""",
    },
    {
        "title": "PATCH component - parameter with name path not allowed",
        "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT#DESCRIPTIOPN;LANGUAGE
SUMMARY:foo
END:PATCH
END:VPATCH
END:VCALENDAR
""",
    },
    {
        "title": "PATCH component - delete path property no name not allowed",
        "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-DELETE:#
BEGIN:VEVENT
END:VEVENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
    },
    {
        "title": "PATCH component - delete path parameter no name not allowed",
        "patch": """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VPATCH
UID:77CA7115-B195-49FF-8AB9-01A1F3AC4F5C
DTSTAMP:20160831T102600Z
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
PATCH-DELETE:#DESCRIPTION;
BEGIN:VEVENT
END:VEVENT
END:PATCH
END:VPATCH
END:VCALENDAR
""",
    },
]


class TestPatchDocument(unittest.TestCase):

    def _testPatch(self, data):

        for ctr, items in enumerate(data):
            calendar = Calendar.parseText(items["before"])
            patcher = PatchDocument(Calendar.parseText(items["patch"]))
            try:
                patcher.applyPatch(calendar)
            except Exception as e:
                self.fail("Failed test #{}: {}\n{}".format(ctr + 1, items["title"], str(e)))
            else:
                self.assertEqual(
                    str(calendar),
                    items["after"].replace("\n", "\r\n"),
                    msg="Failed test #{}: {}\n{}".format(
                        ctr + 1,
                        items["title"],
                        "\n".join(unified_diff(str(calendar).splitlines(), items["after"].splitlines())),
                    ),
                )

    def test_createComponent_Simple(self):
        """
        Test that creation of a single component works.
        """

        self._testPatch(dataValid["create_component_simple"])

    def test_createProperty_Simple(self):
        """
        Test that creation of a single property works.
        """

        self._testPatch(dataValid["create_property_simple"])

    def test_createParameter_Simple(self):
        """
        Test that creation of a single parameter works.
        """

        self._testPatch(dataValid["create_parameter_simple"])

    def test_updateComponent_Simple(self):
        """
        Test that update of components works.
        """

        self._testPatch(dataValid["update_component_simple"])

    def test_updateComponent_Recur(self):
        """
        Test that update of components works.
        """

        self._testPatch(dataValid["update_component_recur"])

    def test_updateProperty_Simple(self):
        """
        Test that update of a single property works.
        """

        self._testPatch(dataValid["update_property_simple"])

    def test_updateParameter_Simple(self):
        """
        Test that update of a single parameter works.
        """

        self._testPatch(dataValid["update_parameter_simple"])

    def test_deleteComponent_Simple(self):
        """
        Test that deletion of a single component works.
        """

        self._testPatch(dataValid["delete_component_simple"])

    def test_deleteProperty_Simple(self):
        """
        Test that deletion of a single property works.
        """

        self._testPatch(dataValid["delete_property_simple"])

    def test_deleteParameter_Simple(self):
        """
        Test that deletion of a single parameter works.
        """

        self._testPatch(dataValid["delete_parameter_simple"])

    def test_invalid(self):
        """
        Test that invalid patch data correctly fail to parse.
        """

        for ctr, items in enumerate(dataInvalid):
            vpatch = Calendar.parseText(items["patch"])
            self.assertTrue(vpatch is not None, msg="Failed to load VPATCH #{}: {}".format(ctr + 1, items["title"]))
            try:
                PatchDocument(vpatch)
            except Exception:
                pass
            else:
                self.fail("Failed test #{} - no exception raised: {}".format(ctr + 1, items["title"]))


def componentData(data):
    """
    Parse the data item into a component.

    @return: a component
    @rtype: L{Component}
    """

    # Data must be a set of components. Wrap the data inside a VCALENDAR and parse
    newdata = """BEGIN:VCALENDAR
VERSION:2.0
PRODID:ignore
{}
END:VCALENDAR
""".format(data)
    calendar = Calendar.parseText(newdata)
    return calendar.getComponents()[0]


class TestCommand(unittest.TestCase):

    def testCreate(self):
        test_data = (
            # Valid
            ("/VCALENDAR", [], None, componentData("BEGIN:VEVENT\r\nEND:VEVENT\r\n"), True,),
            (Path("/VCALENDAR"), [], None, componentData("BEGIN:VEVENT\r\nEND:VEVENT\r\n"), True,),
            ("/VCALENDAR#VERSION", [], None, componentData("BEGIN:PATCH\r\nVERSION:2.0\r\nEND:PATCH\r\n"), True,),
            (Path("/VCALENDAR#VERSION"), [], None, componentData("BEGIN:PATCH\r\nVERSION:2.0\r\nEND:PATCH\r\n"), True,),
            ("/VCALENDAR#VERSION", [], None, None, True,),

            # Invalid
            ("/VCALENDAR", 1, None, componentData("BEGIN:VEVENT\r\nEND:VEVENT\r\n"), False,),
            ("/VCALENDAR", [], 1, componentData("BEGIN:VEVENT\r\nEND:VEVENT\r\n"), False,),
            (1, None, None, componentData("BEGIN:VEVENT\r\nEND:VEVENT\r\n"), False,),
            ("/VCALENDAR", None, None, 1, False,),
        )

        for ctr, item in enumerate(test_data):
            path, deletes, params, data, valid = item
            try:
                command = Command.create(path, deletes, params, data)
            except ValueError as e:
                self.assertFalse(valid, msg="Failed #{}: {}".format(ctr + 1, str(e)))
            else:
                self.assertTrue(valid, msg="Failed #{}".format(ctr + 1))
                self.assertTrue(isinstance(command, Command), msg="Failed #{}".format(ctr + 1))


class TestPath(unittest.TestCase):

    test_data = (
        # Valid

        # Components
        (
            "/VCALENDAR",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
            ],
            None,
            None,
        ),
        (
            "/VCALENDAR/VEVENT",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT"),
            ],
            None,
            None,
        ),
        (
            "/VCALENDAR/VEVENT[UID=1234]",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT[UID=1234]"),
            ],
            None,
            None,
        ),
        (
            "/VCALENDAR/VEVENT[UID=1234%2F4567]",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT[UID=1234/4567]"),
            ],
            None,
            None,
        ),
        (
            "/VCALENDAR/VEVENT[UID=1234][RID=20150907T120000Z]",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT[UID=1234][RID=20150907T120000Z]"),
            ],
            None,
            None,
        ),

        # Properties
        (
            "/VCALENDAR#VERSION",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
            ],
            Path.PropertySegment("VERSION"),
            None,
        ),
        (
            "/VCALENDAR/VEVENT#SUMMARY",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT"),
            ],
            Path.PropertySegment("SUMMARY"),
            None,
        ),
        (
            "/VCALENDAR/VEVENT#SUMMARY[=abc]",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT"),
            ],
            Path.PropertySegment("SUMMARY[=abc]"),
            None,
        ),
        (
            "/VCALENDAR/VEVENT#SUMMARY[=a%2Fc]",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT"),
            ],
            Path.PropertySegment("SUMMARY[=a/c]"),
            None,
        ),
        (
            "/VCALENDAR/VEVENT#SUMMARY[!abc]",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT"),
            ],
            Path.PropertySegment("SUMMARY[!abc]"),
            None,
        ),
        (
            "/VCALENDAR/VEVENT[UID=1234]#SUMMARY",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT[UID=1234]"),
            ],
            Path.PropertySegment("SUMMARY"),
            None,
        ),
        (
            "/VCALENDAR/VEVENT[UID=1234]#SUMMARY[=abc]",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT[UID=1234]"),
            ],
            Path.PropertySegment("SUMMARY[=abc]"),
            None,
        ),
        (
            "/VCALENDAR/VEVENT[UID=1234][RID=20150907T120000Z]#SUMMARY",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT[UID=1234][RID=20150907T120000Z]"),
            ],
            Path.PropertySegment("SUMMARY"),
            None,
        ),
        (
            "/VCALENDAR/VEVENT[UID=1234][RID=20150907T120000Z]#SUMMARY[=abc]",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT[UID=1234][RID=20150907T120000Z]"),
            ],
            Path.PropertySegment("SUMMARY[=abc]"),
            None,
        ),

        # Parameters
        (
            "/VCALENDAR#VERSION;VALUE",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
            ],
            Path.PropertySegment("VERSION"),
            Path.ParameterSegment("VALUE"),
        ),
        (
            "/VCALENDAR/VEVENT#ATTENDEE;PARTSTAT",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT"),
            ],
            Path.PropertySegment("ATTENDEE"),
            Path.ParameterSegment("PARTSTAT"),
        ),
        (
            "/VCALENDAR/VEVENT#ATTENDEE[=abc];PARTSTAT",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT"),
            ],
            Path.PropertySegment("ATTENDEE[=abc]"),
            Path.ParameterSegment("PARTSTAT"),
        ),
        (
            "/VCALENDAR/VEVENT#ATTENDEE[=a%2Fc];PARTSTAT",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT"),
            ],
            Path.PropertySegment("ATTENDEE[=a/c]"),
            Path.ParameterSegment("PARTSTAT"),
        ),
        (
            "/VCALENDAR/VEVENT#ATTENDEE[!abc];PARTSTAT",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT"),
            ],
            Path.PropertySegment("ATTENDEE[!abc]"),
            Path.ParameterSegment("PARTSTAT"),
        ),
        (
            "/VCALENDAR/VEVENT[UID=1234]#ATTENDEE;PARTSTAT",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT[UID=1234]"),
            ],
            Path.PropertySegment("ATTENDEE"),
            Path.ParameterSegment("PARTSTAT"),
        ),
        (
            "/VCALENDAR/VEVENT[UID=1234]#ATTENDEE[=abc];PARTSTAT",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT[UID=1234]"),
            ],
            Path.PropertySegment("ATTENDEE[=abc]"),
            Path.ParameterSegment("PARTSTAT"),
        ),
        (
            "/VCALENDAR/VEVENT[UID=1234][RID=20150907T120000Z]#ATTENDEE;PARTSTAT",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT[UID=1234][RID=20150907T120000Z]"),
            ],
            Path.PropertySegment("ATTENDEE"),
            Path.ParameterSegment("PARTSTAT"),
        ),
        (
            "/VCALENDAR/VEVENT[UID=1234][RID=20150907T120000Z]#ATTENDEE[=abc];PARTSTAT",
            True,
            [
                Path.ComponentSegment("VCALENDAR"),
                Path.ComponentSegment("VEVENT[UID=1234][RID=20150907T120000Z]"),
            ],
            Path.PropertySegment("ATTENDEE[=abc]"),
            Path.ParameterSegment("PARTSTAT"),
        ),

        # Invalid
    )

    def testParse(self):

        for ctr, item in enumerate(TestPath.test_data):
            strpath, valid, components, property, parameter = item
            try:
                path = Path(strpath)
            except ValueError:
                self.assertFalse(valid, msg="Failed #{}".format(ctr + 1))
            else:
                self.assertTrue(valid, msg="Failed #{}".format(ctr + 1))
                self.assertEqual(path.components, components, msg="Failed #{}".format(ctr + 1))
                self.assertEqual(path.property, property, msg="Failed #{}".format(ctr + 1))
                self.assertEqual(path.parameter, parameter, msg="Failed #{}".format(ctr + 1))

    def testType(self):

        data = [
            ("/VCALENDAR", True, False, False,),
            ("/VCALENDAR/VEVENT", True, False, False,),
            ("/VCALENDAR/VEVENT#SUMMARY", False, True, False,),
            ("/VCALENDAR/VEVENT#SUMMARY;X-PARAM", False, False, True,),
        ]

        for strpath, isComponent, isProperty, isParameter in data:
            path = Path(strpath)
            self.assertEqual(path.targetComponent(), isComponent)
            self.assertEqual(path.targetProperty(), isProperty)
            self.assertEqual(path.targetParameter(), isParameter)

    def testStr(self):

        data = [
            "/VCALENDAR",
            "/VCALENDAR/VEVENT",
            "/VCALENDAR/VEVENT[UID=ABC]",
            "/VCALENDAR/VEVENT[UID=ABC][RID=20160830]",
            "/VCALENDAR/VEVENT[UID=ABC][RID=M]",
            "/VCALENDAR/VEVENT[RID=20160830]",
            "/VCALENDAR/VEVENT#SUMMARY",
            "/VCALENDAR/VEVENT#SUMMARY[=XYZ]",
            "/VCALENDAR/VEVENT#SUMMARY[!XYZ]",
            "/VCALENDAR/VEVENT#SUMMARY;X-PARAM",
        ]

        for strpath in data:
            path = Path(strpath)
            self.assertEqual(strpath, str(path), msg="Mismatch for: {} vs {}".format(strpath, str(path)))

    def testMatch_Components_Simple(self):

        icalendar = """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
"""

        calendar = Calendar.parseText(icalendar.replace("\n", "\r\n"))
        path = Path("/VCALENDAR")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertIs(matched[0], calendar)

        path = Path("/VCALENDAR/VEVENT")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertIs(matched[0], calendar.getComponents("VEVENT")[0])

        path = Path("/VCALENDAR/VEVENT[UID=123]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

        path = Path("/VCALENDAR/VEVENT[UID=C3184A66-1ED0-11D9-A5E0-000A958A3252]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertIs(matched[0], calendar.getComponents("VEVENT")[0])

        path = Path("/VCALENDAR/VEVENT[UID=123][RID=20150101T000000Z]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

        path = Path("/VCALENDAR/VEVENT[UID=C3184A66-1ED0-11D9-A5E0-000A958A3252][RID=M]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertIs(matched[0], calendar.getComponents("VEVENT")[0])

        path = Path("/VCALENDAR/VEVENT[UID=123][RID=M]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

        path = Path("/VCALENDAR/VEVENT[UID=C3184A66-1ED0-11D9-A5E0-000A958A3252][RID=20020101]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)

        path = Path("/VCALENDAR/VEVENT[UID=C3184A66-1ED0-11D9-A5E0-000A958A3252][RID=M]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertIs(matched[0], calendar.getComponents("VEVENT")[0])

    def testMatch_Components_Multiple(self):

        icalendar = """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:New Year's Day
END:VEVENT
BEGIN:VEVENT
UID:165EF135-BA92-435A-88C9-562F95030908
DTSTART;VALUE=DATE:20020401
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:April Fool's Day
END:VEVENT
BEGIN:VEVENT
UID:5EA5AF47-77F5-4EEE-9944-69651C97755B
DTSTART;VALUE=DATE:20020921
DURATION:P1D
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY
SUMMARY:Birthday
END:VEVENT
END:VCALENDAR
"""

        calendar = Calendar.parseText(icalendar.replace("\n", "\r\n"))
        components_by_uid = dict([(component.getUID(), component) for component in calendar.getComponents()])

        path = Path("/VCALENDAR")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertIs(matched[0], calendar)

        path = Path("/VCALENDAR/VEVENT")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 3)
        self.assertEqual(
            set([item.getUID() for item in matched]),
            set(components_by_uid.keys()),
        )

        path = Path("/VCALENDAR/VEVENT[UID=123]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

        for key in components_by_uid.keys():
            path = Path("/VCALENDAR/VEVENT[UID={key}]".format(key=key))
            matched = path.match(calendar)
            self.assertEqual(len(matched), 1)
            self.assertIs(matched[0], components_by_uid[key])

        path = Path("/VCALENDAR/VEVENT[UID=123][RID=20150101T000000Z]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

        path = Path("/VCALENDAR/VEVENT[UID=C3184A66-1ED0-11D9-A5E0-000A958A3252][RID=M]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertEqual(
            matched[0],
            components_by_uid["C3184A66-1ED0-11D9-A5E0-000A958A3252"],
        )

        for key in components_by_uid.keys():
            path = Path("/VCALENDAR/VEVENT[UID={key}][RID=20150101T000000Z]".format(key=key))
            matched = path.match(calendar)
            self.assertEqual(len(matched), 1)

        for key in components_by_uid.keys():
            path = Path("/VCALENDAR/VEVENT[UID={key}][RID=M]".format(key=key))
            matched = path.match(calendar)
            self.assertEqual(len(matched), 1)
            self.assertIs(matched[0], components_by_uid[key])

    def testMatch_Components_Recurring(self):

        icalendar = """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART:20020101T120000Z
DURATION:PT1H
DTSTAMP:20020101T000000Z
RRULE:FREQ=DAILY
SUMMARY:Meeting
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID:20020102T120000Z
DTSTART:20020102T130000Z
DURATION:PT1H
DTSTAMP:20020101T000000Z
SUMMARY:Meeting #2
END:VEVENT
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
RECURRENCE-ID:20020103T120000Z
DTSTART:20020103T140000Z
DURATION:PT1H
DTSTAMP:20020101T000000Z
SUMMARY:Meeting #3
END:VEVENT
END:VCALENDAR
"""

        calendar = Calendar.parseText(icalendar.replace("\n", "\r\n"))
        components_by_rid = dict([(component.getRecurrenceID(), component) for component in calendar.getComponents()])

        path = Path("/VCALENDAR")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertIs(matched[0], calendar)

        path = Path("/VCALENDAR/VEVENT")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 3)
        self.assertEqual(
            set([item.getRecurrenceID() for item in matched]),
            set(components_by_rid.keys()),
        )

        path = Path("/VCALENDAR/VEVENT[UID=123][RID=20150101T000000Z]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

        for key in components_by_rid.keys():
            path = Path("/VCALENDAR/VEVENT[UID=C3184A66-1ED0-11D9-A5E0-000A958A3252][RID={key}]".format(key=key if key else "M"))
            matched = path.match(calendar)
            self.assertEqual(len(matched), 1)
            self.assertIs(matched[0], components_by_rid[key])

        path = Path("/VCALENDAR/VEVENT[UID=C3184A66-1ED0-11D9-A5E0-000A958A3252][RID=M]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertIs(matched[0], components_by_rid[None])

    def testMatch_Properties_Simple(self):

        icalendar = """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
"""

        calendar = Calendar.parseText(icalendar.replace("\n", "\r\n"))
        path = Path("/VCALENDAR#VERSION")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertEqual(
            matched[0],
            (calendar, calendar.getProperties("VERSION")[0],),
        )

        path = Path("/VCALENDAR#FOOBAR")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

        path = Path("/VCALENDAR/VEVENT#SUMMARY")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertEqual(
            matched[0],
            (calendar.getComponents()[0], calendar.getComponents()[0].getProperties("SUMMARY")[0],),
        )

        # Non-existent - for_update changes behavior
        path = Path("/VCALENDAR/VEVENT#FOOBAR")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

        path = Path("/VCALENDAR/VEVENT#FOOBAR")
        matched = path.match(calendar, for_update=True)
        self.assertEqual(len(matched), 1)

        path = Path("/VCALENDAR/VEVENT#SUMMARY[=New Year's Day]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertEqual(
            matched[0],
            (calendar.getComponents()[0], calendar.getComponents()[0].getProperties("SUMMARY")[0],),
        )

        # Non-existent - for_update does not change behavior
        path = Path("/VCALENDAR/VEVENT#SUMMARY[=New Years Day]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

        path = Path("/VCALENDAR/VEVENT#SUMMARY[=New Years Day]")
        matched = path.match(calendar, for_update=True)
        self.assertEqual(len(matched), 0)

        path = Path("/VCALENDAR/VEVENT#DTSTART[=20020101]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertEqual(
            matched[0],
            (calendar.getComponents()[0], calendar.getComponents()[0].getProperties("DTSTART")[0],),
        )

        path = Path("/VCALENDAR/VEVENT#RRULE[=20020101]")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

    def testMatch_Parameters_Simple(self):

        icalendar = """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:C3184A66-1ED0-11D9-A5E0-000A958A3252
DTSTART;VALUE=DATE:20020101
DTEND;VALUE=DATE:20020102
DTSTAMP:20020101T000000Z
RRULE:FREQ=YEARLY;UNTIL=20031231;BYMONTH=1
SUMMARY:New Year's Day
END:VEVENT
END:VCALENDAR
"""

        calendar = Calendar.parseText(icalendar.replace("\n", "\r\n"))

        path = Path("/VCALENDAR/VEVENT#SUMMARY;X-PARAM")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertEqual(
            matched[0],
            (calendar.getComponents()[0], calendar.getComponents()[0].getProperties("SUMMARY")[0], "X-PARAM",)
        )

        path = Path("/VCALENDAR/VEVENT#FOOBAR;X-PARAM")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

        path = Path("/VCALENDAR/VEVENT#SUMMARY[=New Year's Day];X-PARAM")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertEqual(
            matched[0],
            (calendar.getComponents()[0], calendar.getComponents()[0].getProperties("SUMMARY")[0], "X-PARAM",)
        )

        path = Path("/VCALENDAR/VEVENT#SUMMARY[=New Years Day];X-PARAM")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 0)

        path = Path("/VCALENDAR/VEVENT#DTSTART[=20020101];VALUE")
        matched = path.match(calendar)
        self.assertEqual(len(matched), 1)
        self.assertEqual(
            matched[0],
            (calendar.getComponents()[0], calendar.getComponents()[0].getProperties("DTSTART")[0], "VALUE",)
        )


class TestComponentSegment(unittest.TestCase):

    test_data = (
        # Valid
        ("VCALENDAR", True, "VCALENDAR", None, None, None,),
        ("VCALENDAR[UID=1234]", True, "VCALENDAR", "1234", None, None,),
        ("VCALENDAR[UID=1234%2F4567]", True, "VCALENDAR", "1234/4567", None, None,),
        ("VCALENDAR[UID=1234][RID=M]", True, "VCALENDAR", "1234", True, None,),
        ("VCALENDAR[UID=1234][RID=20150907T120000Z]", True, "VCALENDAR", "1234", True, "20150907T120000Z",),

        # Invalid
        ("VCALENDAR[]", False, None, None, None, None,),
        ("VCALENDAR[foo]", False, None, None, None, None,),
        ("VCALENDAR[foo=bar]", False, None, None, None, None,),
        ("VCALENDAR[UID=", False, None, None, None, None,),
        ("VCALENDAR[UID=1234][]", False, None, None, None, None,),
        ("VCALENDAR[UID=1234][foo=bar]", False, None, None, None, None,),
        ("VCALENDAR[UID=1234][RID=M", False, None, None, None, None,),
    )

    def testParse(self):

        for ctr, item in enumerate(TestComponentSegment.test_data):
            segment, valid, name, uid, rid, rid_value = item
            try:
                component = Path.ComponentSegment(segment)
            except ValueError:
                self.assertFalse(valid, msg="Failed #{}".format(ctr + 1))
            else:
                self.assertTrue(valid, msg="Failed #{}".format(ctr + 1))
                self.assertEqual(component.name, name, msg="Failed #{}".format(ctr + 1))
                self.assertEqual(component.uid, uid, msg="Failed #{}".format(ctr + 1))
                self.assertEqual(component.rid, rid, msg="Failed #{}".format(ctr + 1))
                self.assertEqual(component.rid_value, DateTime.parseText(rid_value) if rid_value else None, msg="Failed #{}".format(ctr + 1))


class TestPropertySegment(unittest.TestCase):

    test_data = (
        # Valid
        ("STATUS", True, "STATUS", None,),
        ("STATUS[=COMPLETED]", True, "STATUS", ("COMPLETED", operator.eq,),),
        ("STATUS[!COMPLETED]", True, "STATUS", ("COMPLETED", operator.ne,),),
        ("SUMMARY[=a%2Fb]", True, "SUMMARY", ("a/b", operator.eq,),),

        # Invalid
        ("", False, None, None,),
        ("STATUS[]", False, None, None,),
        ("STATUS[foo]", False, None, None,),
        ("STATUS[=]", False, None, None,),
        ("STATUS[=COMPLETED", False, None, None,),
        ("STATUS[=COMPLETED][=FAILED]", False, None, None,),
    )

    def testParse(self):

        for ctr, item in enumerate(TestPropertySegment.test_data):
            segment, valid, name, matchCondition = item
            try:
                property = Path.PropertySegment(segment)
            except ValueError:
                self.assertFalse(valid, msg="Failed #{}".format(ctr + 1))
            else:
                self.assertTrue(valid, msg="Failed #{}".format(ctr + 1))
                self.assertEqual(property.name, name, msg="Failed #{}".format(ctr + 1))
                self.assertEqual(property.matchCondition, matchCondition, msg="Failed #{}".format(ctr + 1))


class TestParameterSegment(unittest.TestCase):

    test_data = (
        # Valid
        ("PARTSTAT", True, "PARTSTAT",),

        # Invalid
        ("", False, None,),
        ("PARTSTAT[]", False, None,),
        ("PARTSTAT[", False, None,),
        ("PARTSTAT[=NEEDS-ACTION]", False, None,),
    )

    def testParse(self):

        for ctr, item in enumerate(TestParameterSegment.test_data):
            segment, valid, name = item
            try:
                property = Path.ParameterSegment(segment)
            except ValueError:
                self.assertFalse(valid, msg="Failed #{}".format(ctr + 1))
            else:
                self.assertTrue(valid, msg="Failed #{}".format(ctr + 1))
                self.assertEqual(property.name, name, msg="Failed #{}".format(ctr + 1))


class TestPatchMaker(unittest.TestCase):

    def test_processSubComponents(self):

        data = [
            {
                "title": "Create component",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:1234
END:VEVENT
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
BEGIN:VEVENT
UID:1234
END:VEVENT
END:PATCH
END:VPATCH
""",
            },
            {
                "title": "Delete component",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:1234
END:VEVENT
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
PATCH-DELETE:/VEVENT
END:PATCH
END:VPATCH
""",
            },
            {
                "title": "Update component",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:1234
SUMMARY:old
END:VEVENT
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
BEGIN:VEVENT
UID:1234
SUMMARY:new
END:VEVENT
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR/VEVENT
SUMMARY:new
END:PATCH
END:VPATCH
""",
            },
        ]

        for item in data:
            oldcal = Calendar.parseText(item["old"])
            newcal = Calendar.parseText(item["new"])
            vpatch = VPatch()
            patchComponent = Patch(parent=vpatch)
            patchComponent.addProperty(Property(definitions.cICalProperty_PATCH_TARGET, "/VCALENDAR"))

            PatchGenerator.processSubComponents(oldcal, newcal, vpatch, "/VCALENDAR", patchComponent)

            if len(patchComponent.getProperties()) + len(patchComponent.getComponents()) > 1:
                vpatch.addComponent(patchComponent)

            self.assertEqual(
                str(vpatch),
                item["patch"].replace("\n", "\r\n"),
                "Failed: {}\n{}".format(item["title"], "\n".join(unified_diff(str(vpatch).splitlines(), item["patch"].splitlines())))
            )

    def test_processProperties(self):

        data = [
            {
                "title": "Create property",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
CALSCALE:GREGORIAN
END:PATCH
END:VPATCH
""",
            },
            {
                "title": "Delete property",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
PATCH-DELETE:#CALSCALE
END:PATCH
END:VPATCH
""",
            },
            {
                "title": "Create & Delete property",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION:Calendar name
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
PATCH-DELETE:#CALSCALE
DESCRIPTION:Calendar name
END:PATCH
END:VPATCH
""",
            },
            {
                "title": "Singleton update property",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.org//Example v0.1//EN
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
PRODID:-//example.org//Example v0.1//EN
END:PATCH
END:VPATCH
""",
            },
            {
                "title": "Create multi-property",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION:Calendar name 1
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION:Calendar name 1
DESCRIPTION:Calendar name 2
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
DESCRIPTION;PATCH-ACTION=CREATE:Calendar name 2
END:PATCH
END:VPATCH
""",
            },
            {
                "title": "Delete multi-property",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION:Calendar name 1
DESCRIPTION:Calendar name 2
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION:Calendar name 1
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
PATCH-DELETE:#DESCRIPTION[=Calendar name 2]
END:PATCH
END:VPATCH
""",
            },
            {
                "title": "Update multi-property",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION:Calendar name 1
DESCRIPTION:Calendar name 2
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION:Calendar name 1
DESCRIPTION:Calendar name 3
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
PATCH-DELETE:#DESCRIPTION[=Calendar name 2]
DESCRIPTION;PATCH-ACTION=CREATE:Calendar name 3
END:PATCH
END:VPATCH
""",
            },
            {
                "title": "Create parameter",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION:Calendar name 1
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION;LANGUAGE=en_US:Calendar name 1
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
DESCRIPTION;LANGUAGE=en_US:Calendar name 1
END:PATCH
END:VPATCH
""",
            },
            {
                "title": "Update parameter",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION;LANGUAGE=en_US:Calendar name 1
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION;LANGUAGE=en_GB:Calendar name 1
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
DESCRIPTION;LANGUAGE=en_GB:Calendar name 1
END:PATCH
END:VPATCH
""",
            },
            {
                "title": "Update multi-parameter",
                "old" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION;LANGUAGE=en_US:Calendar name 1
DESCRIPTION;LANGUAGE=en_GB:Calendar name 2
END:VCALENDAR
""",
                "new" : """BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//example.com//Example v0.1//EN
DESCRIPTION;LANGUAGE=en_US:Calendar name 1
DESCRIPTION;LANGUAGE=en_CA:Calendar name 2
END:VCALENDAR
""",
                "patch": """BEGIN:VPATCH
BEGIN:PATCH
PATCH-TARGET:/VCALENDAR
DESCRIPTION;LANGUAGE=en_CA;PATCH-ACTION=BYVALUE:Calendar name 2
END:PATCH
END:VPATCH
""",
            },
        ]

        for item in data:
            oldcal = Calendar.parseText(item["old"])
            newcal = Calendar.parseText(item["new"])
            vpatch = VPatch()
            patchComponent = Patch(parent=vpatch)
            patchComponent.addProperty(Property(definitions.cICalProperty_PATCH_TARGET, "/VCALENDAR"))
            vpatch.addComponent(patchComponent)
            PatchGenerator.processProperties(oldcal, newcal, vpatch, "", patchComponent)
            self.assertEqual(
                str(vpatch),
                item["patch"].replace("\n", "\r\n"),
                "Failed: {}\n{}".format(item["title"], "\n".join(unified_diff(str(vpatch).splitlines(), item["patch"].splitlines())))
            )


if __name__ == '__main__':
    order = [
        "create_component_simple",
        "create_property_simple",
        "create_parameter_simple",
        "update_component_simple",
        "update_component_recur",
        "update_property_simple",
        "update_parameter_simple",
        "delete_component_simple",
        "delete_property_simple",
        "delete_parameter_simple",
    ]
    if len(order) != len(dataValid.keys()):
        print("WARNING: data and order sizes are different")

    all_data = list(itertools.chain(*[dataValid[key] for key in order]))
    with open(os.path.join(os.path.dirname(__file__), "patch_examples.json"), "w") as f:
        f.write(json.dumps(all_data, indent=2))
    print("Updated patch_example.json")

    with open(os.path.join(os.path.dirname(__file__), "patch_invalid_examples.json"), "w") as f:
        f.write(json.dumps(dataInvalid, indent=2))
    print("Updated patch_invalid_examples.json")
